sudo: required
services:
  - docker
language: python
cache: pip
install:
  - pip install -r requirements-dev.txt -r requirements.txt
jobs:
  include:
    - stage: test
      python: 3.6
      dist: trusty
      sudo: true
      before_install:
      - docker build -t next-action-dev .
      script:
      - docker-compose up update_readme
      - docker-compose up unittest-coverage-upload
    - stage: test
      python: 3.6
      dist: trusty
      sudo: false
      script:
      - coverage run --omit=/home/travis/virtualenv/* --branch -m unittest
      - coverage xml --fail-under=100
      - nosetests --nocapture --with-xunit tests/unittests/  # For SonarQube, see https://docs.sonarqube.org/display/PLUG/Python+Unit+Tests+Execution+Reports+Import
      - sonar-scanner -Dsonar.login=$SONAR_TOKEN
      addons:
        sonarcloud:
          organization: "fniessink-github"
    - stage: deploy
      python: 3.6
      dist: trusty
      sudo: false
      script: true
      deploy:
        provider: pypi
        user: fniessink
        distributions: "sdist bdist_wheel"
        on:
          tags: true
